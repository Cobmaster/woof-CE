#!/bin/bash

find usr/share/applications -iname '*firefox*' -exec sed -i 's, %.$,,g' '{}' \;

# use firefox dir first if found, if not found use firefox*
FF=`find usr/ -maxdepth 2 -type d -name 'firefox' | grep -v /share/`
[ "$FF" == "" ] && FF=`find usr/ -maxdepth 2 -type d -name 'firefox*' | grep -v /share/`

mkdir -p ${FF}/browser/defaults/preferences
PREFDIR="${FF}/browser/defaults/preferences"

cat > ${PREFDIR}/local-settings.js <<_EOF
//
//default home page
defaultPref("browser.startup.homepage", "data:text/plain,browser.startup.homepage=file:///usr/share/doc/home.htm");

// use less vertical space
defaultPref("browser.uidensity", 1);

// render website text while fetching images
defaultPref("nglayout.initialpaint.delay", 0);
defaultPref("layers.progressive-paint", true);

// run smoother without GPU acceleration
defaultPref("general.smoothScroll", false);

// use less disk space and write less often
defaultPref("browser.cache.disk.enable", false);
defaultPref("browser.cache.memory.enable", true);
defaultPref("browser.sessionstore.resume_from_crash", false);

// disable annoyances
defaultPref("browser.ctrlTab.recentlyUsedOrder", false);
defaultPref("browser.aboutwelcome.enabled", false);
defaultPref("browser.newtabpage.enabled", false);
defaultPref("trailhead.firstrun.didSeeAboutWelcome", true);
defaultPref("extensions.pocket.enabled", false);
defaultPref("extensions.screenshots.disabled", true);

// privacy
defaultPref("privacy.trackingprotection.enabled", true);
defaultPref("privacy.resistFingerprinting", true);
defaultPref("privacy.donottrackheader.enabled", true);
defaultPref("toolkit.telemetry.enabled", false);
defaultPref("toolkit.telemetry.unified", false);
defaultPref("toolkit.telemetry.reportingpolicy.firstRun", false);
defaultPref("app.normandy.enabled", false);
defaultPref("datareporting.policy.dataSubmissionEnabled", false);
_EOF

(cd usr/${PLIB}/firefox*
[ -f omni.ja ] && mkdir omnidir
mv omni.ja omnidir/omni.zip
cd omnidir
unzip omni.zip
rm omni.zip
zip -0 -y -R ../newomni '*'
cd ..
mv newomni.zip omni.ja
rm -r omnidir)

(
echo "echo '"'#!/bin/sh'"' > usr/local/bin/defaultbrowser"
echo "echo 'exec firefox \"\$@\"' >> usr/local/bin/defaultbrowser"
echo "chmod 755 usr/local/bin/defaultbrowser"
echo "echo '"'#!/bin/sh'"' > usr/local/bin/defaulthtmlviewer"
echo "echo 'exec firefox \"\$@\"' >> usr/local/bin/defaulthtmlviewer"
echo "chmod 755 usr/local/bin/defaulthtmlviewer"
echo 'echo "setting up Firefox"'
) > pinstall.sh

### END ###
